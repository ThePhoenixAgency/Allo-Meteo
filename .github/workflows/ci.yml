# CI workflow
# - Trigger: push or PR against `main`
# - Purpose: install, build the app, create the local-ai-mcp pack artifact and upload artifacts for later use
# - What to change: change node-version or add additional test steps. To run browsers or E2E, add a job after 'build'.

name: CI

permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    # Map the repository secret GEMINI_API_KEY into API_KEY for scripts that expect process.env.API_KEY.
    # Add GEMINI_API_KEY to repository Secrets (Settings → Secrets and variables → Actions) to use Gemini in CI.
    env:
      API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check GEMINI secret presence (non-fatal)
        # This step is intentionally non-fatal and only prints whether the secret is available.
        run: |
          node -e "console.log(Boolean(process.env.API_KEY) ? 'GEMINI OK' : 'GEMINI MISSING')"

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Build local-ai-mcp pack
        # produces packages/local-ai-mcp/dist/local-ai-mcp-*.tgz
        run: cd packages/local-ai-mcp && npm ci && npm run pack

      - name: Run tests (placeholder)
        # Replace this with your unit test runner (jest, vitest, etc.)
        run: |
          echo "No tests configured" && exit 0

      - name: Upload local-ai-mcp artifact
        uses: actions/upload-artifact@v4
        with:
          name: local-ai-mcp-pack
          path: packages/local-ai-mcp/dist/*.tgz

      - name: Save build info
        run: echo "Built at $(date -u +%Y-%m-%dT%H:%M:%SZ)" > build-info.txt

      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: build-info.txt
